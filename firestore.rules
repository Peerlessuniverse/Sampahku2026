rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Sponsors collection - SECURED
    match /sponsors/{sponsorId} {
      allow read: if true;  // Public read for displaying ads
      allow write: if request.auth != null;  // ðŸ”’ Only authenticated users can modify
    }

    // Users collection - users can read/write their own data
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read: if request.auth != null;  // Admin can read all
    }

    // Transactions collection - users can read their own transactions
    match /transactions/{transactionId} {
      allow read: if request.auth != null &&
                    resource.data.userId == request.auth.uid;
      allow create: if request.auth != null;
    }

    // Wallets (read-only by owner; writes only via Functions/Admin)
    match /wallets/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false;
    }

    // Ledger entries (read-only by owner)
    match /ledgers/{userId}/entries/{entryId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false;
    }

    // Daily Ad Stats (read-only by owner)
    match /adStats/{userId}/days/{dayId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false;
    }

    // Telegram link mapping (read-only to authenticated clients)
    match /telegram_links/{telegramUserId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // Link codes (no direct client access)
    match /linkCodes/{code} {
      allow read: if false;
      allow write: if false;
    }

    // Badge catalog (read-only public)
    match /badge_catalog/{badgeId} {
      allow read: if true;
      allow write: if false;
    }

    // Admin collection - only for admin users (to be enhanced later)
    match /admin/{document=**} {
      allow read, write: if request.auth != null;
    }

    // --- ADS MANAGEMENT SYSTEM ---

    // 1. Partner Requests (Public Registration) - NEW
    match /partner_requests/{requestId} {
      allow create: if true; // Anyone can request access
      allow read, update, delete: if true; // Temporarily allow for simulated admin
    }

    // 2. Partners - NEW
    match /partners/{partnerId} {
      allow read: if true; // Public for identification
      allow write: if true; // Temporarily allow for simulated admin
    }

    // BACKWARD COMPATIBILITY - Keep old collections for migration period
    // 1. Advertiser Requests (DEPRECATED - Use partner_requests)
    match /advertiser_requests/{requestId} {
      allow create: if true; // Anyone can request access
      allow read, update, delete: if true; // Temporarily allow for simulated admin
    }

    // 2. Advertisers (DEPRECATED - Use partners)
    match /advertisers/{advertiserId} {
      allow read: if true; // Public for identification
      allow write: if true; // Temporarily allow for simulated admin
    }

    // 3. Campaigns
    match /campaigns/{campaignId} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // 4. Placements
    match /placements/{placementId} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // 5. Audit Logs
    match /audit_logs/{logId} {
      allow create: if true;
      allow read: if request.auth != null;
    }
  }
}
